output: default
asyncFuncTimeout: 1000
description: Convert AWS OCSF logs (e.g. CloudTrail) to CEF format

functions:
  - id: comment
    filter: "true"
    disabled: false
    conf:
      comment: >
        Pipeline converts OCSF-formatted AWS logs (CloudTrail) to CEF format.

  - id: serde
    filter: "true"
    disabled: false
    conf:
      mode: extract
      type: json
      srcField: _raw
    description: Extract JSON fields from OCSF-formatted _raw log

  - id: eval
    filter: "true"
    disabled: false
    conf:
      add:
        - name: cef_version
          value: "0"
        - name: device_vendor
          value: '"Amazon"'
        - name: device_product
          value: metadata?.product?.name || "UnknownProduct"
        - name: device_version
          value: metadata?.product?.version || "1.0"
        - name: signature_id
          value: event_name || metadata?.feature?.name || "unknownEvent"
        - name: name
          value: event_name || metadata?.feature?.name || "unknownEvent"
        - name: severity
          value: "5"
    description: Map OCSF fields to CEF header fields

  - id: serialize
    filter: "true"
    disabled: false
    conf:
      dstField: _raw
      type: format
      format: >
        CEF:${cef_version}|${device_vendor}|${device_product}|${device_version}|${signature_id}|${name}|${severity}|
        src=${cloud?.ip || source_address || "0.0.0.0"}
        dst=${cloud?.account_id || "unknown"}
        suser=${user?.name || "unknownUser"}
        request=${request || "none"}
        msg=${event_name || "NoMessage"}
        dvc=${cloud?.region || "unknown"}
        rt=${time_dt || ""}
    description: Serialize as CEF format

  - id: eval
    filter: "true"
    disabled: false
    conf:
      add:
        - name: sourcetype
          value: '"aws:cloudtrail:cef"'
        - name: source
          value: '"aws:cloudtrail"'
        - name: index
          value: '"default"'
      keep:
        - _time
        - index
        - host
        - source
        - sourcetype
        - _raw
    description: Final metadata mapping

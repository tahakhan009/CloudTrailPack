name: OCSF_to_CEF
description: "Convert OCSF-formatted logs (e.g. AWS CloudTrail) to CEF format"
groups:
  cef_conversion:
    name: OCSF to CEF
    description: Extract fields and format as CEF
    index: 1

functions:
  - id: eval
    filter: '_raw != null'
    conf:
      expressions:
        - cribl_breaker: '"Break on newlines"'
        - cef_version: '"0"'
        - device_vendor: '"Amazon"'
        - device_product: 'metadata?.product?.name || "UnknownProduct"'
        - device_version: 'metadata?.product?.version || "1.0"'
        - signature_id: 'event_name || metadata?.feature?.name || "unknownEvent"'
        - name: 'event_name || metadata?.feature?.name || "unknownEvent"'
        - severity: 'metadata?.severity_id?.toString() || "5"'
        - raw_event_time: 'time || time_dt'
        - source: '"aws:ocsf"'
        - sourcetype: '"aws:ocsf:cef"'
        - index: '"default"'

  - id: serialize_cef
    filter: '_raw != null'
    conf:
      versionField: 'cef_version'
      deviceVendorField: 'device_vendor'
      deviceProductField: 'device_product'
      deviceVersionField: 'device_version'
      signatureIdField: 'signature_id'
      nameField: 'name'
      severityField: 'severity'
      extensionFields:
        - event_name
        - user?.uid
        - user?.name
        - src_endpoint?.ip
        - dst_endpoint?.ip
        - cloud?.region
        - cloud?.account?.uid
        - metadata?.product?.name
        - metadata?.feature?.name
        - time_dt
        - time
      outputField: '_raw'
      charset: 'UTF-8'
      emptyFieldValue: '-'
      extensionFormat: 'keyvalue'

  - id: drop
    filter: 'false'
    conf: {}

